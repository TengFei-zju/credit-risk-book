# 第二章 业务理解与需求转化

## 2.1 为什么算法工程师要懂业务

风控建模的失败，往往不是因为模型不够复杂，而是因为**建了一个解决错误问题的模型**。

常见的"技术正确但业务错误"陷阱：

- 用申请时点数据预测6个月以上违约，却忽略了产品本身期限只有3个月
- AUC很高但在高风险段区分度差，而高风险段恰好是策略重点关注区间
- 模型在样本外表现良好，但忽略了业务系统只能接受整数分值

---

## 2.2 明确建模目标

### 2.2.1 标签定义：最重要却最容易被忽视的步骤

**Y变量的定义直接决定模型的实际含义。**

以"坏客户"定义为例：

| 定义方式 | 含义 | 适用场景 |
|---------|------|---------|
| FPD（首期逾期） | 第一期未还 | 识别欺诈、极端风险 |
| M1（逾期1期） | 任意期次逾期1次 | 宽松定义，样本多 |
| M2+ | 逾期2期以上 | 中等风险 |
| M3+（或90天+） | 逾期3期以上，接近监管不良定义 | 严格信用风险 |
| 核销/损失 | 实际发生损失 | LGD建模 |

**关键考量**：
- 坏样本比例（Bad Rate）：通常需要 ≥1%，否则样本过于稀疏
- 观察窗口（Observation Window）：看哪个时间点的申请人特征
- 表现窗口（Performance Window）：给多长时间让违约行为显现

```
时间轴示意：

  [申请时点]---[观察窗口]---[表现窗口起点]---[表现窗口终点]
       ↑                        ↑                 ↑
    特征提取                 开始计违约          判断好坏
```

### 2.2.2 样本定义

```python
# 示例：样本筛选的常见逻辑
def define_sample(df):
    """
    定义建模样本
    - 排除极短期已核销（可能是数据问题）
    - 排除政策外因素导致的异常（如疫情期间批量展期）
    - 保证表现期完整（账龄 >= performance_window）
    """
    sample = df.copy()

    # 1. 排除数据不完整的记录
    sample = sample[sample['loan_age'] >= PERFORMANCE_WINDOW]

    # 2. 排除政策性展期（特殊时期）
    sample = sample[sample['is_policy_extension'] == 0]

    # 3. 排除极早核销（可能是欺诈，单独建模）
    sample = sample[~(sample['is_written_off'] & (sample['dpd_at_writeoff'] < 30))]

    return sample
```

---

## 2.3 时间窗口设计

### 2.3.1 三个关键窗口

```
Past              Present            Future
|<-- 历史窗口 -->|<-- 观察点 -->|<-- 表现窗口 -->|
   (特征构建期)     (申请时点)      (Y标签判断期)
```

- **历史窗口**：用多长时间的历史数据构建特征（通常3~12个月）
- **观察点**：模型"看到"申请人信息的时刻
- **表现窗口**：等多久判断好坏（消费金融通常6~12个月，房贷可能24个月）

### 2.3.2 数据穿越（Data Leakage）：最危险的陷阱

**定义**：特征中包含了标签发生之后的信息，导致模型在线上表现远差于离线评估。

```python
# 错误示范：使用了未来数据
# 假设 overdue_times 包含了整个贷款周期的逾期次数
df['feature_overdue_times'] = df['total_overdue_times']  # 穿越！

# 正确做法：只使用观察点之前的数据
df['feature_overdue_times'] = df.apply(
    lambda row: count_overdue_before(row['loan_id'], row['observation_date']),
    axis=1
)
```

**常见穿越类型**：

| 类型 | 示例 | 识别方法 |
|------|------|---------|
| 直接穿越 | 特征直接包含Y变量 | 相关性异常高（>0.9） |
| 间接穿越 | 催收电话次数（坏客户才会被催） | 业务逻辑审查 |
| 时间穿越 | 用申请后的行为数据 | 严格的时间戳校验 |

---

## 2.4 业务约束条件整理

在建模前，需要与业务方明确以下约束：

### 2.4.1 技术约束

```markdown
checklist：
□ 模型上线方式（API/规则引擎/批量跑分）
□ 打分延迟要求（实时<100ms / 准实时<5s / 离线批量）
□ 特征在线可用性（哪些变量实时能取到）
□ 分值输出格式（整数/小数/分档）
□ 是否需要输出理由码（reject reason）
```

### 2.4.2 业务约束

```markdown
checklist：
□ 目标通过率（如：维持当前通过率 ± 5%）
□ 目标风险水位（如：M1+逾期率不超过 X%）
□ 特定人群保护（如：不得因性别、民族等因素差异定价）
□ 监管合规要求（拒绝原因说明）
```

---

## 2.5 需求转化：从业务语言到建模语言

### 案例：行为评分需求转化

**业务需求（原始）**：
> "我们希望识别出近期还款变差的存量客户，对他们做额度下调"

**转化过程**：

| 维度 | 业务语言 | 建模语言 |
|------|---------|---------|
| 预测目标 | 还款变差 | 未来3个月内发生M2+逾期 |
| 样本 | 存量客户 | 贷款余额>0，账龄3~24个月的在贷客户 |
| 特征 | 近期 | 过去1/3/6个月的还款行为特征 |
| 输出 | 识别结果 | 风险评分分档（高/中/低风险） |
| 应用 | 额度下调 | 高风险段触发额度review流程 |

**输出建模方案文档**：

```markdown
## 存量客户行为评分 v1.0 建模方案

### 建模目标
预测在贷客户未来3个月内发生M2+逾期的概率

### 样本定义
- 入样条件：贷款余额>0，账龄3~24个月
- 排除条件：展期/延期客户，已进入催收流程客户
- 观察时点：每月月末截面
- 表现窗口：3个月
- 训练样本时间范围：2023Q1~2024Q1（含时间外样本验证）

### 标签定义
- 坏 (Y=1)：表现期内最大逾期期数 ≥ 2
- 好 (Y=0)：表现期内最大逾期期数 = 0
- 不确定：最大逾期期数 = 1（可排除或单独处理）

### 特征体系（草案）
- 还款行为：历史逾期次数、最大逾期期数、最近还款日期距当前天数
- 账户状态：当前余额、已还本金比例、剩余期数
- 外部信号：近3个月征信查询次数（如可获取）
```

---

## 2.6 沟通与对齐技巧

**与风控策略团队**：
- 关注"分数能不能直接用于策略分档"，而非只关注AUC
- 提前讨论边界客群（如白名单、黑名单客户如何处理）

**与数据团队**：
- 明确哪些特征是实时可用，哪些有延迟
- 提前做数据探查（缺失率、覆盖率）

**与系统/工程团队**：
- 模型输出格式、调用方式
- 上线切量计划（灰度/全量）

---

> **本章小结**：好的建模方案从清晰的业务需求出发，标签定义、样本设计、时间窗口是建模成功的地基。宁可花两周反复对齐需求，也不要花两个月建一个方向错误的模型。
